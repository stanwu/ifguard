# ifguard-iptop-json

Minimal `iftop`-like CLI that reads raw TCP packets on Linux and prints per-IP counters as JSON Lines.

This tool can be used to detect abnormal high-traffic IP connections and feed downstream hardware-firewall automation for IP blocking.

## Features

- Reads packets with `AF_PACKET` raw socket (requires root / `CAP_NET_RAW`)
- Tracks per-peer IP counters (`in_bytes`, `out_bytes`, `in_pkts`, `out_pkts`)
- Emits JSON every N seconds
- Supports window mode (reset each interval) and cumulative mode

## Use Cases

- Detect abnormal high-traffic IP connections and trigger hardware-firewall auto-block workflows.
- Early DDoS detection by identifying sudden traffic spikes from source IPs.
- Egress hotspot analysis to tune QoS/rate-limiting and protect shared bandwidth.
- Host anomaly monitoring (unexpected outbound bursts, potential data exfiltration, scanning behavior).
- SIEM/SOC data feed by forwarding JSON lines to ELK/Splunk/Graylog pipelines.
- Baseline and drift detection for hybrid cloud/on-prem traffic behavior.
- API/service protection by driving dynamic WAF or gateway rules from real-time IP counters.
- Incident response support by quickly identifying top talkers during attack windows.

## Why Read Packets Before iptables

- Earlier visibility for bursty traffic and attack patterns before firewall decision points.
- Observation is not hidden by existing DROP rules, which improves investigation quality.
- Enables pre-firewall risk scoring and automation decisions for downstream controls.
- Reduces firewall rule bloat by sending only high-confidence block candidates.
- Improves observability with raw per-IP traffic metrics for SIEM, reports, and audits.
- Supports multi-layer defense orchestration (iptables, WAF, and hardware firewalls).
- Practical boundary: this layer is for detection/telemetry; high-performance packet dropping is better handled by XDP/eBPF.

## Requirements

- Linux
- Python 3.9+
- Root privileges for sniffing

## Install

```bash
cd /home/stan/ifguard
python3 -m venv .venv
source .venv/bin/activate
pip install -e .
```

## Usage

```bash
sudo .venv/bin/ifguard-iptop -i eth0 --cumulative
```

Window mode (reset every 10 seconds by default):

```bash
sudo .venv/bin/ifguard-iptop -i eth0
```

Output top 50 peers:

```bash
sudo .venv/bin/ifguard-iptop -i eth0 -n 50 --cumulative
```

## Output Example

```json
{
  "ts": 1739700000,
  "iface": "eth0",
  "local_ip": "192.168.1.10",
  "interval_sec": 10.0,
  "mode": "cumulative",
  "top": [
    {
      "ip": "1.1.1.1",
      "in_bytes": 1040,
      "out_bytes": 890,
      "in_pkts": 8,
      "out_pkts": 6,
      "total_bytes": 1930,
      "total_pkts": 14
    }
  ]
}
```

## Notes

- Current implementation focuses on IPv4 TCP packets.
- For more exact on-wire behavior, NIC offload settings can affect capture semantics.

## Make Targets

```bash
make install
make test
make run IFACE=eth0
```

## CI

- GitHub Actions workflow at `.github/workflows/ci.yml` runs `make test` on every push and pull request.

## License

- MIT (see `LICENSE`)

## Project Note

- This project is 100% generated by Codex.
